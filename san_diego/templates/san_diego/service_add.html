{% extends 'san_diego/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Add service{% endblock %}

{%block content %}
<style>
    .hidden {
        display: none
    }
</style>
<div class='container'>
    <h1 class='mt-4'>{{ car.client }} | {{ car.car_make }} {{ car.car_model }}</h1>
    <form method='POST' action="" enctype='multipart/form-data' id='carForm' data-carmodels-url="{% url 'ajax_load_car_models' %}">
        <hr class='mb-4'>
        {% csrf_token %}
        <!-- SERVICE FORM -->
        {{ form.management_form }}
        {{ form.non_form_errors }}
        <div id='services'>
        {% for form in form %}
            {{form.id}}
            {{ form.errors|as_crispy_errors }}
            <div class='services-form'>
                <div class='form-row'>
                    <div class='form-group col-md-8 mb-3'>
                        {{ form.service_name }}
                    </div>
                    <div class='form-group col-md-4 mb-3'>
                        {{ form.service_price }}
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
        <div id='empty_form' class='hidden'>
            {% comment %} {% for field in form.empty_form %} {% endcomment %}
                <div class='form-row'>
                    <div class='form-group col-md-8 mb-3'>
                        {{ form.errors|as_crispy_errors }}
                        {{ form.empty_form.service_name }}
                    </div>
                    <div class='form-group col-md-4 mb-3'>
                        {{ form.empty_form.service_price }}
                    </div>
                </div>
            {% comment %} {% endfor %} {% endcomment %}
        </div>
        <!-- CARPARTS FORM -->
        {{formset.management_form}}
        {{formset.non_form_errors}}
        <div id='parts'>
            {%for form in formset%}
                {{form.id}}
                {{form.errors|as_crispy_errors}}
                <div class='parts-form'>
                    <div class='row ml-1'>
                    {% for field in form %}
                        {{field.errors|as_crispy_errors}}
                        <div class='mb-2 mr-2'>{{field}}</div>
                    {% endfor %}
                    </div>
                </div>
            {%endfor%}
        </div>
        <div id='empty_formset' class='hidden'>
            <div class='row ml-2'>
            {% for field in formset.empty_form %}
                    {{ field.errors|as_crispy_errors }}
                    <div class='mb-2 mr-2'>{{ field }}</div>
            {% endfor %}
            </div>
        </div>
        <hr/>
        <div class='row'>
            <button type='submit' class='btn btn-success mt-2 ml-3'>Save</button>
            {% comment %} <button type='submit' name='another' class='btn btn-outline-success mt-2 ml-2'>Save and add another</button> {% endcomment %}
            <button id='add_service' type='button' class='btn btn-outline-success mt-2 ml-2'>Add service</button>
            <buttton id='add_part' type='button' class='mt-2 btn btn-link text-info ml-auto'><i class="fas fa-plus"></i> Add part</button>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<script>
    // <!-- JS for adding new PART formsets via button -->
    const addMorePartsBtn = document.getElementById('add_part')
    const totalNewFormsets = document.getElementById('id_carpart_formset-TOTAL_FORMS')

    addMorePartsBtn.addEventListener('click', add_new_formset)
    function add_new_formset(event) {
        if (event) {
            event.preventDefault()
        }
        const currentPartForms = document.getElementsByClassName('parts-form')
        const currentFormCount = currentPartForms.length //+1
        const formCopyTarget = document.getElementById('parts')
        const copyEmptyFormEl = document.getElementById('empty_formset').cloneNode(true)
        copyEmptyFormEl.setAttribute('class', 'parts-form')
        copyEmptyFormEl.setAttribute('id', `form-${currentFormCount}`)
        const regex = new RegExp('__prefix__', 'g')
        copyEmptyFormEl.innerHTML = copyEmptyFormEl.innerHTML.replace(regex, currentFormCount)
        totalNewFormsets.setAttribute('value', currentFormCount + 1)

        formCopyTarget.append(copyEmptyFormEl)
    }
    // <!-- JS for adding new SERVICE formsets via button -->
    const addMoreBtn = document.getElementById('add_service')
    const totalNewForms = document.getElementById('id_service_formset-TOTAL_FORMS')

    addMoreBtn.addEventListener('click', add_new_form)
    function add_new_form(event) {
        if (event) {
            event.preventDefault()
        }
        const currentServiceForms = document.getElementsByClassName('services-form')
        const currentFormCount = currentServiceForms.length //+1
        const formCopyTarget = document.getElementById('services')
        const copyEmptyFormEl = document.getElementById('empty_form').cloneNode(true)
        copyEmptyFormEl.setAttribute('class', 'services-form')
        copyEmptyFormEl.setAttribute('id', `form-${currentFormCount}`)
        const regex = new RegExp('__prefix__', 'g')
        copyEmptyFormEl.innerHTML = copyEmptyFormEl.innerHTML.replace(regex, currentFormCount)
        totalNewForms.setAttribute('value', currentFormCount + 1)

        formCopyTarget.append(copyEmptyFormEl)
    }
</script>
{% endblock content %}